# https://docs.travis-ci.com/user/customizing-the-build/

branches:
  only:
    - master
language: node_js
node_js: 8
matrix:
  include:
    - os: osx
      osx_image: xcode9.0
    - os: linux
      sudo: false
      dist: trusty
      group: stable
      addons:
        apt:
          packages:
            - gnome-keyring
            - libsecret-1-dev
            - python-gnomekeyring
env:
  global:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
    - FAILURE_ZIP_FILE=travis-build-id-$TRAVIS_BUILD_ID.zip
cache:
  directories:
    - node_modules
    - $HOME/.cache/electron
    - $HOME/.cache/electron-builder
before_install:
  - |
    echo install awscli
    pip install --user awscli
    export PATH=$PATH:$HOME/.local/bin
  - |
    echo setup virtual screen
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export DISPLAY=:99.0
      sh -e /etc/init.d/xvfb start
      sleep 3
    fi
  - |
    echo start gnome-keyring-daemon
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      eval $(echo -n "" | /usr/bin/gnome-keyring-daemon --login);
      eval $(/usr/bin/gnome-keyring-daemon --components=secrets --start);
      dbus-launch /usr/bin/python -c "import gnomekeyring;gnomekeyring.create_sync('login', '');"
    fi
install:
  - node --version
  - npm --version
  - npm install
script:
  - npm run app:build
  - npm run electron-builder:release
after_failure:
  - zip -r $FAILURE_ZIP_FILE $(git ls-files -o | grep -Fv -e node_modules -e dist -e app)
  - aws --endpoint=$AWS_ENDPOINT_URL s3 cp $FAILURE_ZIP_FILE s3://$AWS_BUCKET
notifications:
  email:
    on_success: never
    on_failure: change
